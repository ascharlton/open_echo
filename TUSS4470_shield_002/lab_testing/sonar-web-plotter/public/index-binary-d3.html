<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Echo Seafloor Profile (D3.js)</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body { 
            font-family: sans-serif; 
            background-color: #212121; 
            color: #ffffff; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            padding-top: 20px; 
        }
        .container { 
            width: 95%; 
            max-width: 1280px; 
        }
        .info-bar { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            background-color: #2b2b2b; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .info-panel {
            display: flex;
            gap: 20px;
        }
        .info-item { 
            padding: 0 10px; 
        }
        #seafloor-chart { 
            background-color: #000000; 
            border-radius: 8px; 
        }
        .line {
            fill: none;
            stroke: rgb(75, 192, 192); 
            stroke-width: 1.5px;
        }
        .axis text {
            fill: #ffffff;
        }
        .axis path, .axis line {
            stroke: #555555;
        }

        .toggle-button {
            background-color: #555;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .toggle-button:hover {
            background-color: #777;
        }
        .toggle-button.active {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-Time Seafloor Distance Profile (D3.js)</h1>

        <div class="info-bar">
            <div class="info-panel">
                <div class="info-item">Current Distance: <span id="distance-output">N/A</span> cm</div>
                <div class="info-item">Peak Value: <span id="peak-output">N/A</span></div>
                <div class="info-item" id="status-el">Status: Connecting...</div>
            </div>
            <button id="scale-toggle" class="toggle-button">Toggle Y-Axis Scale (Static)</button>
        </div>

        <div id="seafloor-chart"></div>
    </div>

    <script>
        // ðŸ›‘ UPDATED: Set HISTORY_LENGTH to 500 frames
        const HISTORY_LENGTH = 1500; 
        const STATIC_MAX_CM = 200; 
        const DYNAMIC_BUFFER_PERCENT = 0.10; 

        // Data history array initialized to the new length
        let distanceHistory = new Array(HISTORY_LENGTH).fill(0); 
        let firstDataReceived = false; 

        const distanceEl = document.getElementById('distance-output');
        const peakEl = document.getElementById('peak-output');
        const statusEl = document.getElementById('status-el');
        const scaleToggleButton = document.getElementById('scale-toggle');
        
        let isDynamicScale = false;

        // --- D3 Chart Setup ---

        // Chart dimensions
        const CHART_WIDTH = 1250;
        const CHART_HEIGHT = 480;
        const margin = { top: 20, right: 30, bottom: 50, left: 60 };
        const width = CHART_WIDTH - margin.left - margin.right;
        const height = CHART_HEIGHT - margin.top - margin.bottom;

        // 1. Create the SVG container
        const svg = d3.select("#seafloor-chart")
            .append("svg")
            .attr("width", CHART_WIDTH)
            .attr("height", CHART_HEIGHT)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 2. Define Scales
        // X-Scale: Domain is now 0 to 499
        const xScale = d3.scaleLinear()
            .domain([0, HISTORY_LENGTH - 1]) 
            .range([0, width]);

        // Y-Scale
        let yScale = d3.scaleLinear()
            .domain([STATIC_MAX_CM, 0]) 
            .range([0, height]);
        
        // 3. Define the Line Generator
        const lineGenerator = d3.line()
            .x((d, i) => xScale(i))
            .y(d => yScale(d))
            .defined(d => d > 0.0) 
            .curve(d3.curveMonotoneX); 

        // 4. Draw Initial Axes
        // ðŸ›‘ UPDATED: Tick format now shows a tick every 50 frames for the 500 frame range
        const xAxis = d3.axisBottom(xScale).tickFormat(d => d % 50 === 0 ? d : null);
        const yAxis = d3.axisLeft(yScale);

        const xAxisGroup = svg.append("g")
            .attr("class", "x axis")
            .attr("transform", `translate(0,${height})`)
            .call(xAxis);

        const yAxisGroup = svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        // Add Axis Labels
        svg.append("text")
            .attr("class", "axis-label")
            .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .style("fill", "white")
            .text("Time (Frames)");

        svg.append("text")
            .attr("class", "axis-label")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .style("fill", "white")
            .text("Distance (cm)");

        // 5. Create the Path element for the line
        const path = svg.append("path")
            .attr("class", "line")
            .attr("d", lineGenerator(distanceHistory));


        // --- D3 Drawing and Update Logic ---
        
        function redrawChart() {
            path.attr("d", lineGenerator(distanceHistory));
            yAxisGroup.call(yAxis);
        }

        // --- Scaling Logic Function ---

        function updateYAxisScale() {
            const button = scaleToggleButton;
            
            if (isDynamicScale) {
                const filteredData = distanceHistory.filter(d => d > 0); 
                
                if (filteredData.length > 1) {
                    const minVal = Math.min(...filteredData);
                    const maxVal = Math.max(...filteredData);
                    
                    const range = maxVal - minVal;
                    const buffer = range * DYNAMIC_BUFFER_PERCENT / 2; 

                    const finalBuffer = Math.max(buffer, 0.1); 
                    
                    yScale.domain([
                        Math.ceil(maxVal + finalBuffer),
                        Math.max(0, Math.floor(minVal - finalBuffer))
                    ]);

                } else {
                    yScale.domain([STATIC_MAX_CM, 0]);
                }
                
                button.textContent = 'Toggle Y-Axis Scale (Dynamic)';
                button.classList.add('active');
            } else {
                yScale.domain([STATIC_MAX_CM, 0]);
                
                button.textContent = 'Toggle Y-Axis Scale (Static)';
                button.classList.remove('active');
            }

            redrawChart(); 
        }

        // --- Toggle Button Event Listener ---

        scaleToggleButton.addEventListener('click', () => {
            isDynamicScale = !isDynamicScale; 
            
            // Reset state and data to new length
            distanceHistory = new Array(HISTORY_LENGTH).fill(0);
            firstDataReceived = false; 
            
            updateYAxisScale(); 
        });


        // --- WebSocket Client ---
        const ws = new WebSocket(`ws://${location.hostname}:3000`);
        ws.binaryType = 'arraybuffer'; 

        ws.onopen = () => {
            statusEl.textContent = 'Status: Connected';
        };

        ws.onmessage = (event) => {
            try {
                // Decode Binary Data
                const arrayBuffer = event.data;
                const dataView = new DataView(arrayBuffer);
                const distMM = dataView.getUint16(0, false);
                const distance = distMM / 10.0;
                const peakValue = dataView.getUint8(2); 
                
                // Determine if this is the first valid data point
                if (!firstDataReceived && distance > 0.1) { 
                    firstDataReceived = true;
                }

                // 1. Update info panel
                distanceEl.textContent = distance.toFixed(2);
                peakEl.textContent = peakValue; 
                statusEl.textContent = 'Status: Streaming Data';

                // 2. Update the scrolling history arrays
                distanceHistory.shift(); 
                distanceHistory.push(distance);
                
                // 3. Update the chart only AFTER we've confirmed valid data has arrived
                if (firstDataReceived) {
                    if (isDynamicScale) {
                        updateYAxisScale(); 
                    } else {
                        redrawChart(); 
                    }
                }

            } catch (e) {
                console.error('Client-side data processing failed:', e);
                statusEl.textContent = 'Status: Processing Error';
            }
        };
    </script>
</body>
</html>